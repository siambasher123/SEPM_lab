name: University Management CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  build-and-test:
    name: "Spring Boot Build & Test to check"
    runs-on: ubuntu-latest

    env:
      SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/school1
      SPRING_DATASOURCE_USERNAME: studentuser
      SPRING_DATASOURCE_PASSWORD: studentpass
      SPRING_PROFILES_ACTIVE: test

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: studentuser
          POSTGRES_PASSWORD: studentpass
          POSTGRES_DB: school1
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Make Maven Wrapper Executable
        run: chmod +x mvnw

      # Build without tests first
      - name: Build with Maven
        run: ./mvnw clean install -DskipTests

      # Run Spotless formatting
      - name: Run Spotless apply (format)
        run: ./mvnw com.diffplug.spotless:spotless-maven-plugin:apply

      # Commit formatting changes if any (using built-in GITHUB_TOKEN)
      - name: Commit formatted code if changed
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if ! git diff --quiet; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add -A
            git commit -m "chore: apply code formatting" || echo "No changes to commit"
            git push https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git HEAD:${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}
          else
            echo "No formatting changes"
          fi





      # Run tests
      - name: Run Unit Tests
        run: ./mvnw test
        env:
          MAVEN_OPTS: -Xmx2g